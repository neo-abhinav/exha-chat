<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neon Crystal (Ultra Lite)</title>


<!-- Load Three.js (3D Engine) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<!-- Load MediaPipe Hands (AI) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>

<style>
    body {
        margin: 0;
        background-color: #050505;
        overflow: hidden;
        font-family: monospace;
        color: #00ffcc;
    }
    canvas {
        display: block;
        position: absolute;
        top: 0; left: 0;
        z-index: 1;
    }
    #ui {
        position: absolute;
        top: 10px; left: 10px;
        z-index: 10;
        background: rgba(0,0,0,0.7);
        padding: 10px;
        border: 1px solid #00ffcc;
        border-radius: 4px;
        pointer-events: none;
    }
    .status-dot {
        display: inline-block;
        width: 8px; height: 8px;
        border-radius: 50%;
        background: red;
        margin-right: 5px;
    }
    .active { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
    .loading { background: yellow; }
    
    #controls {
        position: absolute;
        bottom: 20px; width: 100%;
        text-align: center;
        z-index: 10;
        color: #666;
        font-size: 12px;
        pointer-events: none;
    }
    /* Hidden video */
    .input_video { display: none; }
</style>
</head>
<body>


<div id="ui">
    <div><span id="cam-dot" class="status-dot"></span> <span id="status-text">Starting Graphics...</span></div>
    <div style="margin-top:5px; font-size: 10px; color: #aaa;">FPS: <span id="fps">0</span></div>
</div>

<div id="controls">
    Control: Open Hand (Camera) OR Mouse Move (Manual)
</div>

<!-- Video Element for processing -->
<video class="input_video" playsinline muted autoplay></video>

<script>
    // --- 1. SETUP VERY SIMPLE 3D SCENE ---
    const scene = new THREE.Scene();
    // Add some fog for depth
    scene.fog = new THREE.FogExp2(0x050505, 0.05);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.z = 5;

    const renderer = new THREE.WebGLRenderer({ 
        antialias: false, // Turn off antialiasing for speed
        powerPreference: "low-power" // Tell browser to prioritize battery/speed
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    // Limit pixel ratio to 1 for old screens (prevents lag on retina screens)
    renderer.setPixelRatio(1); 
    document.body.appendChild(renderer.domElement);

    // --- 2. CREATE THE OBJECT (Low Poly Crystal) ---
    // Icosahedron is very low poly (20 faces)
    const geometry = new THREE.IcosahedronGeometry(1.5, 0); 
    
    // Wireframe material is very fast to render
    const material = new THREE.MeshBasicMaterial({ 
        color: 0x00ffcc, 
        wireframe: true,
        transparent: true,
        opacity: 0.8
    });
    
    const crystal = new THREE.Mesh(geometry, material);
    scene.add(crystal);

    // Add an inner core
    const coreGeo = new THREE.IcosahedronGeometry(0.5, 0);
    const coreMat = new THREE.MeshBasicMaterial({ color: 0xff00ff, wireframe: true });
    const core = new THREE.Mesh(coreGeo, coreMat);
    scene.add(core);

    // --- 3. STATE MANAGEMENT ---
    const state = {
        expansion: 0, // 0 to 1
        isHandFound: false,
        mouseX: 0
    };

    const ui = {
        dot: document.getElementById('cam-dot'),
        text: document.getElementById('status-text'),
        fps: document.getElementById('fps')
    };

    // --- 4. ANIMATION LOOP ---
    let lastTime = 0;
    let frameCount = 0;
    let lastFpsTime = 0;

    function animate(time) {
        requestAnimationFrame(animate);

        // FPS Counter
        if (time - lastFpsTime >= 1000) {
            ui.fps.innerText = frameCount;
            frameCount = 0;
            lastFpsTime = time;
        }
        frameCount++;

        // 1. Determine Input Source
        let targetScale = 1.0;
        
        if (state.isHandFound) {
            // If camera sees hand, use hand openness
            targetScale = 1.0 + (state.expansion * 2.0);
        } else {
            // Fallback: Breathing animation + Mouse
            const breath = Math.sin(time * 0.002) * 0.2; // Auto breathe
            const mouseInput = Math.abs(state.mouseX) * 1.5; // Mouse override
            targetScale = 1.0 + breath + mouseInput;
        }

        // 2. Smoothly animate the crystal (Lerp)
        const currentScale = crystal.scale.x;
        const smooth = 0.1; // speed of smoothing
        const newScale = currentScale + (targetScale - currentScale) * smooth;

        crystal.scale.set(newScale, newScale, newScale);
        core.scale.set(newScale * 0.5, newScale * 0.5, newScale * 0.5);

        // 3. Rotation
        crystal.rotation.x += 0.005;
        crystal.rotation.y += 0.01;
        core.rotation.x -= 0.01;
        core.rotation.y -= 0.02;

        // 4. Color Shift based on size
        const hue = (newScale * 100) % 360;
        material.color.setHSL(hue / 360, 1, 0.5);

        renderer.render(scene, camera);
    }
    
    // Start animation immediately (don't wait for camera)
    animate(0);
    ui.text.innerText = "3D Ready. Loading Camera...";
    ui.dot.className = "status-dot loading";

    // --- 5. INPUT HANDLERS (Mouse/Touch) ---
    window.addEventListener('mousemove', (e) => {
        // Normalize mouse from -1 to 1
        state.mouseX = (e.clientX / window.innerWidth) * 2 - 1;
    });
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // --- 6. CAMERA & AI SETUP (Lazy Loading) ---
    async function startCamera() {
        try {
            const videoElement = document.querySelector('.input_video');
            
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`;
            }});

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, // 0 = LITE (Fastest), 1 = FULL
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults((results) => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    state.isHandFound = true;
                    ui.dot.className = "status-dot active";
                    ui.text.innerText = "Hand Detected";
                    
                    // Calculate Openness
                    const lm = results.multiHandLandmarks[0];
                    const wrist = lm[0];
                    const tip = lm[9]; // Middle finger tip
                    
                    // Distance between wrist and middle finger
                    const dist = Math.sqrt(
                        Math.pow(tip.x - wrist.x, 2) + 
                        Math.pow(tip.y - wrist.y, 2)
                    );
                    
                    // Map distance to 0-1 range
                    // A fist is usually around 0.1, open hand around 0.3-0.4
                    let open = (dist - 0.1) * 4.0; 
                    if (open < 0) open = 0;
                    if (open > 1) open = 1;
                    
                    state.expansion = open;
                } else {
                    state.isHandFound = false;
                    ui.dot.className = "status-dot active"; // Still active, just no hand
                    ui.text.innerText = "Camera Active (No Hand)";
                }
            });

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 320,  // Very low resolution input for speed
                height: 240
            });

            await cameraUtils.start();

        } catch (error) {
            console.error(error);
            ui.dot.className = "status-dot";
            ui.text.innerText = "Camera Failed. Use Mouse.";
        }
    }

    // Delay camera start slightly to let UI render
    setTimeout(startCamera, 1000);

</script>
</body>
</html>
