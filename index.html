<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neon Crystal (Ultra Lite)</title>

<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>

<style>
body {
    margin: 0;
    background: #050505;
    overflow: hidden;
    font-family: monospace;
    color: #00ffcc;
}
canvas {
    position: absolute;
    top: 0;
    left: 0;
}
#ui {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
    background: rgba(0,0,0,0.7);
    padding: 10px;
    border: 1px solid #00ffcc;
}
.status-dot {
    width: 8px;
    height: 8px;
    display: inline-block;
    border-radius: 50%;
    background: red;
    margin-right: 5px;
}
.active { background: #00ff00; }
.loading { background: yellow; }
.input_video { display: none; }
</style>
</head>

<body>

<div id="ui">
    <div><span id="cam-dot" class="status-dot"></span>
        <span id="status-text">Initializing...</span>
    </div>
    <div style="font-size:10px">FPS: <span id="fps">0</span></div>
</div>

<video class="input_video" playsinline muted></video>

<script>
// ---------------- SCENE ----------------
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x050505, 0.05);

const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 100);
camera.position.z = 5;

const renderer = new THREE.WebGLRenderer({
    antialias: false,
    powerPreference: "low-power"
});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(1);
document.body.appendChild(renderer.domElement);

// ---------------- OBJECT ----------------
const geometry = new THREE.IcosahedronGeometry(1.5, 0);
const material = new THREE.MeshBasicMaterial({
    color: 0x00ffcc,
    wireframe: true,
    transparent: true,
    opacity: 0.8
});
const crystal = new THREE.Mesh(geometry, material);
scene.add(crystal);

const core = new THREE.Mesh(
    new THREE.IcosahedronGeometry(0.5, 0),
    new THREE.MeshBasicMaterial({ color: 0xff00ff, wireframe: true })
);
scene.add(core);

// ---------------- STATE ----------------
const state = {
    expansion: 0,
    hand: false,
    mouseX: 0
};

const ui = {
    dot: document.getElementById("cam-dot"),
    text: document.getElementById("status-text"),
    fps: document.getElementById("fps")
};

// ---------------- ANIMATION ----------------
let frames = 0, lastFPS = 0;

function animate(time) {
    requestAnimationFrame(animate);

    if (time - lastFPS > 1000) {
        ui.fps.textContent = frames;
        frames = 0;
        lastFPS = time;
    }
    frames++;

    let target = 1;

    if (state.hand) {
        target = 1 + state.expansion * 2;
    } else {
        target = 1 + Math.sin(time * 0.002) * 0.2 + Math.abs(state.mouseX) * 1.5;
    }

    const scale = crystal.scale.x + (target - crystal.scale.x) * 0.1;
    crystal.scale.set(scale, scale, scale);
    core.scale.set(scale * 0.5, scale * 0.5, scale * 0.5);

    crystal.rotation.x += 0.005;
    crystal.rotation.y += 0.01;
    core.rotation.x -= 0.01;
    core.rotation.y -= 0.02;

    material.color.setHSL((scale * 100 % 360) / 360, 1, 0.5);

    renderer.render(scene, camera);
}
animate(0);

// ---------------- INPUT ----------------
addEventListener("mousemove", e => {
    state.mouseX = e.clientX / innerWidth * 2 - 1;
});
addEventListener("resize", () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
});

// ---------------- CAMERA ----------------
async function startCamera() {
    const video = document.querySelector(".input_video");

    try {
        const hands = new Hands({
            locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${f}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 0,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(res => {
            if (res.multiHandLandmarks?.length) {
                state.hand = true;
                ui.dot.className = "status-dot active";
                ui.text.textContent = "Hand Detected";

                const lm = res.multiHandLandmarks[0];
                const wrist = lm[0];
                const tip = lm[12]; // middle finger TIP

                let d = Math.hypot(tip.x - wrist.x, tip.y - wrist.y);
                state.expansion = Math.min(Math.max((d - 0.1) * 4, 0), 1);
            } else {
                state.hand = false;
                ui.text.textContent = "Camera Active (No Hand)";
            }
        });

        const cam = new Camera(video, {
            onFrame: async () => {
                if (video.videoWidth > 0) {
                    await hands.send({ image: video });
                }
            },
            width: 320,
            height: 240
        });

        await video.play();
        await cam.start();

        ui.dot.className = "status-dot active";
        ui.text.textContent = "Camera Active";

    } catch (e) {
        console.error(e);
        ui.text.textContent = "Camera Failed â€” Mouse Mode";
    }
}

setTimeout(startCamera, 1000);
</script>

</body>
</html>
